{% extends 'layout.html' %}
{% set title = gettext('admin.pages.title') %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="card-title mb-0">{{ title }}</h2>
    <span class="badge bg-secondary fs-6">{{ gettext('admin.total') }}: {{ total_count }}</span>
</div>

<form method="get" action="{{ url_for('admin.pages.index') }}" class="mb-4">
    <div class="row g-2">
        <div class="col-md-5">
             <div class="input-group">
                <span class="input-group-text bg-white" id="doc-search"><i class="fa fa-search"></i></span>
                <input type="text" class="form-control" id="doc-search-input" name="query"
                       value="{{ query or '' }}"
                       placeholder="{{ gettext('admin.pages.search') }}" autocomplete="off">
            </div>
            <div id="doc-results" class="list-group position-absolute w-100 shadow" style="z-index: 1000; top: 40px; display: none;"></div>
        </div>

        <div class="col-md-4">
            <select name="status" id="status-select" class="form-select" onchange="this.form.submit()">
                <option value="">{{ gettext('admin.users.status') }} ({{ gettext('admin.total') }})</option>
                {% for status in statuses %}
                    <option value="{{ status.value }}" {% if selected_status == status.value %}selected{% endif %}>
                        {% if status.value == 'active' or status.value == 'approved' %}{{ gettext('admin.status.approved') }}
                        {% elif status.value == 'pending' %}{{ gettext('admin.status.pending') }}
                        {% elif status.value == 'rejected' %}{{ gettext('admin.status.rejected') }}
                        {% else %}{{ status.value|title }}{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3 d-flex">
            <button type="submit" class="btn btn-primary me-1 w-100">
                <i class="fa fa-filter"></i>
            </button>
             <a href="{{ url_for('admin.pages.index') }}" class="btn btn-outline-secondary w-50" title="{{ gettext('admin.cancel') }}">
                <i class="fa fa-times"></i>
            </a>
        </div>
    </div>
</form>

{% macro sort_link(field, label) %}
    {% set new_order = 'asc' %}
    {% set icon = 'fa-sort' %}
    {% set text_class = 'text-muted' %}

    {% if current_sort == field %}
        {% set text_class = 'text-dark fw-bold' %}
        {% if current_order == 'asc' %}
            {% set new_order = 'desc' %}
            {% set icon = 'fa-sort-asc' %}
        {% else %}
            {% set new_order = 'asc' %}
            {% set icon = 'fa-sort-desc' %}
        {% endif %}
    {% endif %}

    <a href="{{ url_for('admin.pages.index') }}?sort={{ field }}&order={{ new_order }}&query={{ query or '' }}&status={{ selected_status or '' }}"
       class="text-decoration-none {{ text_class }}">
        {{ label }} <i class="fa {{ icon }} ms-1 small"></i>
    </a>
{% endmacro %}

<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="bg-light">
            <tr>
                <th>{{ sort_link('title', gettext('admin.pages.doc_title')) }}</th>
                <th>{{ gettext('admin.pages.student') }}</th>
                <th>{{ sort_link('created_at', gettext('admin.achievements.date')) }}</th>
                <th>{{ sort_link('status', gettext('admin.users.status')) }}</th>
                <th>{{ gettext('admin.actions') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            <tr>
                <td><strong>{{ doc.title }}</strong></td>
                <td>
                    <a href="{{ url_for('admin.users.show', id=doc.user.id) }}" class="text-decoration-none">
                        {{ doc.user.first_name }} {{ doc.user.last_name }}
                    </a>
                    <br><small class="text-muted">{{ doc.user.email }}</small>
                </td>
                <td>
                    {% if doc.created_at %}
                        {{ doc.created_at.strftime('%Y-%m-%d') }}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if doc.status.value == 'pending' %}
                        <span class="badge bg-warning text-dark">{{ gettext('admin.status.pending') }}</span>
                    {% elif doc.status.value == 'approved' %}
                        <span class="badge bg-success">{{ gettext('admin.status.approved') }}</span>
                    {% else %}
                        <span class="badge bg-danger">{{ gettext('admin.status.rejected') }}</span>
                    {% endif %}
                </td>
                <td>
                    <a href="/{{ doc.file_path }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fa fa-download"></i>
                    </a>
                    <form action="{{ url_for('admin.pages.delete', id=doc.id) }}" method="post" onsubmit="return confirm('Delete?');" class="d-inline ms-1">
                        <button type="submit" class="btn btn-sm btn-danger"><i class="fa fa-trash-o"></i></button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="text-center py-4 text-muted">{{ gettext('admin.no_items_found') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
const searchInput = document.getElementById('doc-search-input');
const statusSelect = document.getElementById('status-select');
const resultsContainer = document.getElementById('doc-results');

searchInput.addEventListener('input', async function() {
    const query = this.value.trim();
    if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }

    const params = new URLSearchParams({ query: query });
    if (statusSelect.value) params.append('status', statusSelect.value);

    try {
        const response = await fetch(`/admin/pages/search?${params.toString()}`);
        const docs = await response.json();
        if (docs.length > 0) {
            resultsContainer.innerHTML = '';
            docs.forEach(doc => {
                const item = document.createElement('a');
                item.href = `{{ url_for('admin.pages.index') }}?query=${encodeURIComponent(doc.title)}`;
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';

                let badgeClass = 'bg-secondary';
                if(doc.status === 'approved') badgeClass = 'bg-success';
                else if(doc.status === 'pending') badgeClass = 'bg-warning text-dark';
                else if(doc.status === 'rejected') badgeClass = 'bg-danger';

                item.innerHTML = `
                    <div>
                        <div class="fw-bold">${doc.title}</div>
                        <small class="text-muted">${doc.user}</small>
                    </div>
                    <span class="badge ${badgeClass} rounded-pill" style="font-size: 0.6rem;">${doc.status}</span>
                `;
                resultsContainer.appendChild(item);
            });
            resultsContainer.style.display = 'block';
        } else {
            resultsContainer.style.display = 'none';
        }
    } catch (error) {
        console.error('Search error:', error);
    }
});

document.addEventListener('click', function(e) {
    if (e.target !== searchInput && e.target !== resultsContainer) {
        resultsContainer.style.display = 'none';
    }
});
</script>
{% endblock %}