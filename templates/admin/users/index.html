{% extends 'layout.html' %}
{% set title = gettext('admin.users.title') %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="card-title mb-0">{{ title }}</h2>
    <span class="badge bg-secondary fs-6">{{ gettext('admin.total') }}: {{ total_count }}</span>
</div>

<form method="get" action="{{ url_for('admin.users.index') }}" class="mb-4">
    <div class="row g-2">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="fa fa-search"></i></span>
                <input type="text" class="form-control" id="user-search-input" name="query"
                       value="{{ query or '' }}"
                       placeholder="{{ gettext('admin.users.search') }}" autocomplete="off">
            </div>
            <div id="search-results" class="list-group position-absolute w-100 shadow" style="z-index: 1000; top: 40px; display: none;"></div>
        </div>

        <div class="col-md-3">
            <select name="role" id="role-select" class="form-select" onchange="this.form.submit()">
                <option value="">{{ gettext('admin.users.role') }} ({{ gettext('admin.total') }})</option>
                {% for role in roles %}
                    <option value="{{ role.value }}" {% if selected_role == role.value %}selected{% endif %}>
                        {{ role.value|title }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <select name="status" id="status-select" class="form-select" onchange="this.form.submit()">
                <option value="">{{ gettext('admin.users.status') }} ({{ gettext('admin.total') }})</option>
                {% for status in statuses %}
                    <option value="{{ status.value }}" {% if selected_status == status.value %}selected{% endif %}>
                        {% if status.value == 'active' %}{{ gettext('admin.status.active') }}
                        {% elif status.value == 'pending' %}{{ gettext('admin.status.pending') }}
                        {% elif status.value == 'rejected' %}{{ gettext('admin.status.rejected') }}
                        {% elif status.value == 'deleted' %}{{ gettext('admin.status.deleted') }}
                        {% else %}{{ status.value|title }}{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2 d-flex">
            <button type="submit" class="btn btn-primary me-1 w-100">
                <i class="fa fa-filter"></i>
            </button>
            <a href="{{ url_for('admin.users.index') }}" class="btn btn-outline-secondary w-50" title="{{ gettext('admin.cancel') }}">
                <i class="fa fa-times"></i>
            </a>
        </div>
    </div>
</form>

{% macro sort_link(field, label) %}
    {% set new_order = 'asc' %}
    {% set icon = 'fa-sort' %}
    {% set text_class = 'text-muted' %}

    {% if current_sort == field %}
        {% set text_class = 'text-dark fw-bold' %}
        {% if current_order == 'asc' %}
            {% set new_order = 'desc' %}
            {% set icon = 'fa-sort-asc' %}
        {% else %}
            {% set new_order = 'asc' %}
            {% set icon = 'fa-sort-desc' %}
        {% endif %}
    {% endif %}

    <a href="{{ url_for('admin.users.index') }}?sort={{ field }}&order={{ new_order }}&query={{ query or '' }}&role={{ selected_role or '' }}&status={{ selected_status or '' }}"
       class="text-decoration-none {{ text_class }}">
        {{ label }} <i class="fa {{ icon }} ms-1 small"></i>
    </a>
{% endmacro %}

{% if users|length > 0 %}
<table class="table table-hover align-middle">
<thead class="bg-light">
    <tr>
        <th class="col">{{ sort_link('first_name', gettext('admin.users.user')) }}</th>
        <th class="col">{{ sort_link('email', gettext('admin.users.email')) }}</th>
        <th class="col">{{ sort_link('role', gettext('admin.users.role')) }}</th>
        <th class="col">{{ gettext('admin.users.phone') }}</th>
        <th class="col">{{ sort_link('status', gettext('admin.users.status')) }}</th>
        <th class="col text-end">{{ gettext('admin.actions') }}</th>
    </tr>
</thead>
 <tbody>
    {% for user in users%}
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    {% if user.avatar_path %}
                        <img src="/{{ user.avatar_path }}" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                    {% else %}
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white me-2" style="width: 32px; height: 32px; font-size: 0.8rem;">
                            {{ user.first_name[0] }}{{ user.last_name[0] }}
                        </div>
                    {% endif %}
                    {{ user.first_name }} {{ user.last_name }}
                </div>
            </td>
            <td>{{ user.email }}</td>
            <td><span class="badge bg-secondary">{{ user.role|title }}</span></td>
            <td>{{ user.phone_number }}</td>
            <td>
                {% if user.status.value == 'active' %}
                    <span class="badge bg-success">{{ gettext('admin.status.active') }}</span>
                {% elif user.status.value == 'pending' %}
                    <span class="badge bg-warning text-dark">{{ gettext('admin.status.pending') }}</span>
                {% elif user.status.value == 'rejected' %}
                    <span class="badge bg-danger">{{ gettext('admin.status.rejected') }}</span>
                {% elif user.status.value == 'deleted' %}
                    <span class="badge bg-secondary">{{ gettext('admin.status.deleted') }}</span>
                {% endif %}
            </td>
            <td class="text-end">
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('admin.users.show', id=user.id) }}" title="{{ gettext('admin.btn.view') }}">
                     <i class="fa fa-eye"></i>
                </a>

                {% if request.session['auth_id'] == user.id %}
                <a class="btn btn-sm btn-light" href="{{ url_for('admin.users.edit', id=user.id) }}" title="Edit">
                     <i class="fa fa-pencil"></i>
                </a>
                {% endif %}

                {% if request.session['auth_id'] != user.id and request.session['auth_role'] in ['moderator', 'super_admin'] %}
                    {% if user.status.value == 'deleted' %}
                        <button class="btn btn-sm btn-danger ms-1" onclick="deleteUser({{ user.id }}, true)" title="{{ gettext('admin.btn.delete_permanent') }}">
                           <i class="fa fa-times-circle"></i>
                        </button>
                    {% else %}
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteUser({{ user.id }}, false)" title="{{ gettext('admin.btn.delete') }}">
                           <i class="fa fa-trash-o"></i>
                        </button>
                    {% endif %}
                {% endif %}
            </td>
        </tr>
    {% endfor %}
 </tbody>
</table>
 {% else %}
    <p class="mb-1 mt-1 p-2 text-muted text-center">{{ gettext('admin.no_items_found') }}</p>
{% endif %}

<script>
// Функция удаления с использованием стандартного confirm
async function deleteUser(id, isPermanent) {
    let msg = isPermanent ? "{{ gettext('admin.users.delete_permanent_confirm') }}" : "{{ gettext('admin.users.delete_confirmation') }}";

    if (!confirm(msg)) return;

    try {
        const res = await fetch(`/admin/users/${id}`, { method: "DELETE" });
        if (res.ok) {
            const data = await res.json();
            // Перезагрузка с параметрами для тоста
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set('toast_msg', data.message);
            newUrl.searchParams.set('toast_type', "success");
            window.location.href = newUrl.toString();
        } else {
            if (typeof showToast === "function") {
                showToast("{{ gettext('admin.failed_delete') }}", 'error');
            } else {
                alert("{{ gettext('admin.failed_delete') }}");
            }
        }
    } catch (e) {
        if (typeof showToast === "function") {
            showToast("Error: " + e, 'error');
        }
    }
}

// Логика поиска "на лету"
const searchInput = document.getElementById('user-search-input');
const roleSelect = document.getElementById('role-select');
const statusSelect = document.getElementById('status-select');
const resultsContainer = document.getElementById('search-results');

searchInput.addEventListener('input', async function() {
    const query = this.value.trim();
    if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }

    const params = new URLSearchParams({ query: query });
    if (roleSelect.value) params.append('role', roleSelect.value);
    if (statusSelect.value) params.append('status', statusSelect.value);

    try {
        const response = await fetch(`/admin/users/search?${params.toString()}`);
        const users = await response.json();
        if (users.length > 0) {
            resultsContainer.innerHTML = '';
            users.forEach(user => {
                const item = document.createElement('a');
                item.href = `/admin/users/${user.id}`;
                item.className = 'list-group-item list-group-item-action d-flex align-items-center';
                let avatarHtml = '';
                if (user.avatar) {
                    avatarHtml = `<img src="/${user.avatar}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">`;
                } else {
                    const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2);
                    avatarHtml = `<div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white me-2" style="width: 30px; height: 30px; font-size: 0.7rem;">${initials}</div>`;
                }
                item.innerHTML = `
                    ${avatarHtml}
                    <div>
                        <div class="fw-bold">${user.name}</div>
                        <small class="text-muted">${user.email}</small>
                    </div>
                `;
                resultsContainer.appendChild(item);
            });
            resultsContainer.style.display = 'block';
        } else {
            resultsContainer.style.display = 'none';
        }
    } catch (error) {
        console.error('Search error:', error);
    }
});

document.addEventListener('click', function(e) {
    if (e.target !== searchInput && e.target !== resultsContainer) {
        resultsContainer.style.display = 'none';
    }
});
</script>
{% endblock %}